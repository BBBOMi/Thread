# Tomcat
톰캣을 WAS 라고도 부르고 서블릿 컨테이너라고도 부른다. 기본적인 웹 서버를 만들 때 우리는 동적 문서를 위해 톰캣을 사용한다. 클라이언트에서 request가 들어오면 request 파라미터를 통해서 무슨 리퀘스트가 들어왔는지 확인하고 jsp를 사용하면 jsp에 적혀 있는 자바 코드를 실행한 뒤 클라이언트에게 반환한다. 이렇게 각 요청에 따라 반응하는 방법은 알지만 정확하게 톰캣이 어떻게 작동하는지는 모른다. 이 문서에서는 톰캣이 어떻게 작동하는지 알아보려고 한다.

## Connection
컴퓨터와 컴퓨터 간에 데이터를 전송하거나 받을 때는 연결이 필요하다. 우리는 보통 TCP/IP를 이용하여 연결을 한다. 하지만 우리는 톰캣을 이용하여 웹 서버를 작성할 때 연결을 명시해준 적이 없다. 그러면 연결은 어떻게 되는 것일까?

먼저 OS를 통하여 연결 요청이 오면 connection queue 에 넣는다. 운영체제에 따라 다른데, 이 connection queue 는 1개 있을 수도 있고 2개 있을 수도 있다. 여기서는 2개를 기준으로 설명해본다. 2개일 경우, 큐는 incomplete connection queue와 connection queue 2종류로 나뉜다. 클라이언트로 부터 연결 요청이 오면 일단 incomplete connection queue 에 넣어둔다. 그 뒤 연결 요청을 수락(accept) 하면 connection queue 에 넣는다. 이 연결을 통해 클라이언트와 서버 간에 통신을 하게 된다.

## acceptor

이제 클라이언트와 연결이 완료되었다. 하지만 이 연결만 하였지 실제 통신을 시작하진 않았다. 그러면 연결한 뒤에는 어떻게 작동할까?

연결이 완료된 것들을(정확히는 소켓이다) acceptor 라는 스레드가 작업용 스레드로 옮겨준다. 이 과정을 통해 실제 일하는 곳으로 이 연결을 옮겨주는 것이다.

> 소켓은 컴퓨터와 컴퓨터간의 연결을 위한 매개체라고 생각하면 된다. 소켓을 통해 데이터를 보내고 소켓을 통해 데이터를 받는다. 소켓의 관리는 운영체제가 해준다.
## Thread Pool

acceptor 스레드가 연결된 것을 Thread Pool로 옮겨준다. 여기서 실제 일을 하는 스레드를 만들어 연결된 클라이언트와 실제 우리가 코드로 만들 작업을 실행하는 것이다. 

acceptor 스레드는 먼저 Thread Pool에 놀고 있는 스레드가 있는지 확인한다. 놀고 있는 스레드가 있으면 그 스레드한테 연결을 넘기고 다시 연결을 받으러 connection queue로 이동한다. 놀고 있는 스레드가 없다면 새로 스레드 풀에서 스레드를 만들고 거기에 연결을 넘겨준다. 하지만 현재 일하고 있는 스레드의 갯수가 최대치면, 어떤 스레드가 일이 끝날 때까지 기다리고 최대치 아래가 되면 연결을 넘겨주고 다시 connection queue로 이동한다. 그리고 실제 일은 연결을 받은 스레드들이 하게 된다. 그렇기 때문에 각각의 요청 처리는 독립된 스레드가 처리하게 되는 것이다. 

## 정리
위의 내용들을 그림으로 그리면 다음과 같다. 

> 그림에는 전부 설명하지 않은 부분이 있다. 그 부분은 뒤에서 계속 설명하기로 한다.


![enter image description here](https://github.com/shouwn/Thread/blob/master/images/tomcat.gif)
